<template>
  <div class="page">
      <div class="page__header">
          <Header />
      </div>

      <div class="page__main">
        <!-- ÊñáÁ´†Âå∫Âüü -->
        <div class="article-main">
            <!-- ÊñáÁ´†ÂÜÖÂÆπ ‰∏é ËØÑËÆ∫Âå∫Âüü -->
            <div class="article-area">
                <!-- ÊñáÁ´†‰∏ª‰ΩìÂå∫Âüü -->
                <div class="article">
                    
                    <!-- Ê†áÈ¢ò -->
                    <div class="article-title">{{articleDetail.title}}</div>

                    <!-- ‰ΩúËÄÖ‰ø°ÊÅØÂå∫Âüü -->
                    <div class="article-info-box">
                        <a href="" class="user-photo">
                            <img :src="articleDetail.avatarLarge" alt="Áî®Êà∑Â§¥ÂÉè">
                        </a>
                        <div class="author-info">
                            <div class="author-name">
                                <span class="name">{{articleDetail.userName}}</span>
                                <span><img src="../assets/img/lv-2.png" alt=""></span>
                            </div>
                            <div class="meta-box">
                                <span class="time">{{articleTime}}</span>
                                <span>ÈòÖËØª {{articleDetail.viewCount}}</span>
                            </div>
                        </div>
                        <button class="follow-btn">+ ÂÖ≥Ê≥®</button>
                    </div>

                    <!-- ÊñáÁ´†ÂõæÁâáÂ±ïÁ§∫ÔºàÂèØËÉΩÊ≤°ÊúâÔºâ -->
                    <div v-if="articleDetail.coverImage" class="article-img">
                        <img :src="articleDetail.coverImage" alt="">
                    </div>

                    <!-- Êï∞ÊçÆÂä†ËΩΩÊó∂ÂëàÁé∞ÁöÑÈ™®Êû∂ -->
                    <el-skeleton :rows="4" animated style="width:700px" class="listSkeleton" v-if="loading" />

                    <!-- ÊñáÁ´†‰∏ª‰ΩìÂÜÖÂÆπ -->
                    <div class="article-content" ref="articleBox">
                        <Viewer class="viewer" :tabindex="2" :value="value" :plugins="plugins"></Viewer>
                    </div>
                    
                    <!-- ÊñáÁ´†Ê†áÁ≠æÂå∫Âüü -->
                    <div class="tag-list-box">
                        <div class="list" v-if="firstTag">ÂàÜÁ±ªÔºö
                            <span>{{firstTag}}</span>
                        </div>
                        <div class="list" v-if="articleDetail.tags">Ê†áÁ≠æÔºö
                            <span v-for="(item,index) of articleDetail.tags" :key="index">{{item}}</span>
                        </div>
                    </div>
                </div>

                <!-- ËØÑËÆ∫Âå∫ -->
                <div class="comment">
                    <!-- ÂèëÈÄÅËØÑËÆ∫ -->
                    <div class="comment-form">
                        <div class="form-header">ËØÑËÆ∫</div>
                        <div class="form-content">
                            <div class="form-userimg">
                                <img src="../assets/img/user.png" alt="">
                            </div>
                            <div class="form-box">
                                <textarea name="" id="" cols="92" rows="3" style="resize:none" placeholder="ËæìÂÖ•ËØÑËÆ∫ (EnterÊç¢Ë°åÔºåCtrl + EnterÂèëÈÄÅ)"></textarea>
                                <div class="action-box">
                                    <div class="emoji-btn">üòÄË°®ÊÉÖ</div>
                                    <div class="image-btn">üñºÂõæÁâá</div>
                                    <div class="submit-box">
                                        <span>Ctrl + Enter</span>
                                        <button class="submit">ÂèëË°®ËØÑËÆ∫</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ÁÉ≠Èó®ËØÑËÆ∫ -->
                    <div class="hot-list">
                        <div class="title">
                            <span>ÁÉ≠Èó®ËØÑËÆ∫</span>
                            <img src="../assets/img/fire.png" alt="">
                        </div>
                        <div class="list">
                            <!-- ‰∏ÄÊù°ËØÑËÆ∫ -->
                            <div class="comment-item">
                                <div class="comment-userImg">
                                    <a href="" class="userImg">
                                        <img src="https://p9-passport.byteacctimg.com/img/mosaic-legacy/3791/5035712059~300x300.image" alt="">
                                    </a>
                                </div>
                                <div class="comment-content">
                                    <div class="comment-main">
                                        <div class="user-box">
                                            <span class="name">ÈùíÂ±±ÁªøÊ∞¥ÈïøÊµÅ</span>
                                            <span class="level"><img src="../assets/img/lv-2.png" alt=""></span>
                                            <span class="jueyou-level"><img src="../assets/img/jy.png" alt=""></span>
                                            <span class="position">ÂâçÁ´ØÂºÄÂèë</span>
                                            <span class="time">1‰∏™Êúà</span>
                                        </div>
                                        <div class="content-main">È´òÁ∫ßÁ®ãÂ∫èÂëòÁöÑË°®Áé∞ÂΩ¢Âºè</div>
                                        <div class="comment-action-box">
                                            <div class="item-zan">
                                                <img src="../assets/img/zan__off.png" alt="">211
                                            </div>
                                            <div class="item-comNum">
                                                <img src="../assets/img/ping.png" alt="">ÂõûÂ§ç
                                            </div>
                                        </div>
                                    </div>
                                    <div class="subcomment-wrapper"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ÂÖ®ÈÉ®ËØÑËÆ∫ -->
                    <div class="comment-list-wrapper">
                        <div class="title">
                            <span>ÂÖ®ÈÉ®ËØÑËÆ∫</span>
                            <span>&nbsp;&nbsp;1</span>
                        </div>
                        <div class="list">
                            <div class="comment-item">
                                <div class="comment-userImg">
                                    <a href="" class="userImg">
                                        <img src="https://p9-passport.byteacctimg.com/img/mosaic-legacy/3791/5035712059~300x300.image" alt="">
                                    </a>
                                </div>
                                <div class="comment-content">
                                    <div class="comment-main">
                                        <div class="user-box">
                                            <span class="name">ÈùíÂ±±ÁªøÊ∞¥ÈïøÊµÅ</span>
                                            <span class="level"><img src="../assets/img/lv-2.png" alt=""></span>
                                            <span class="jueyou-level"><img src="../assets/img/jy.png" alt=""></span>
                                            <span class="position">ÁßªÂä®Á´ØÂºÄÂèë</span>
                                            <span class="time">1‰∏™Êúà</span>
                                        </div>
                                        <div class="content-main">È´òÁ∫ßÁ®ãÂ∫èÂëòÁöÑË°®Áé∞ÂΩ¢Âºè</div>
                                        <div class="comment-action-box">
                                            <div class="item-zan">
                                                <img src="../assets/img/zan__off.png" alt="">211
                                            </div>
                                            <div class="item-comNum">
                                                <img src="../assets/img/ping.png" alt="">ÂõûÂ§ç
                                            </div>
                                        </div>
                                    </div>
                                    <div class="subcomment-wrapper"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ‰æßËæπÊ†è -->
            <div class="sidebar">   
                <!-- ‰ΩúËÄÖ‰ø°ÊÅØÊ†è -->
                <div class="author-block" ref="authorBox">
                    <div class="user-item">
                        <div class="userimg">
                            <img :src="articleDetail.avatarLarge" alt="Áî®Êà∑Â§¥ÂÉè">
                        </div>
                    
                        <div class="info-box">
                            <div class="userName">
                                <span>{{articleDetail.userName}}</span>
                                <img src="../assets/img/lv-2.png" alt="">
                            </div>
                            <div class="position">{{articleDetail.jobTitle}}</div>
                        </div>
                    </div>
                    <div class="stat-item">
                        <div><img src="../assets/img/userZan.png" alt=""></div>
                        <span>Ëé∑ÂæóÁÇπËµû {{zanObj.number}}</span>
                    </div>
                    <div class="stat-item">
                        <div><img src="../assets/img/userEye.png" alt=""></div>
                        <span>ÊñáÁ´†Ë¢´ÈòÖËØª {{articleDetail.viewCount}}</span>
                    </div>
                </div>

                <!-- ÊñáÁ´†ÁõÆÂΩï -->
                <div class="sticky-block-box activeBox" :class="stickyStatus" ref="stickyBox" style="margin-top: 60px;" v-if="titlesLen">
                    <div class="sticky-title">ÁõÆÂΩï</div>
                    <!-- ÁõÆÂΩï‰∏ª‰Ωì -->
                    <div class="sticky-content" ref="stickyContentBox">
                        <el-skeleton :rows="3" animated class="listSkeleton" v-if="loading" />
                        <!-- <div class="first" ref="listFirstBox"></div> -->
                        <ul class="sticky-list">
                            <li class="item" :class="[currentTitle == title.currentTitleId ? 'first' : '']" v-for="title in titles" :key="title.id">
                                <div class="a-container" :style="{ marginLeft: title.level * 20 + 'px' }" :title="title.rawName" @click="scrollToView(title.scrollTop - 40)">{{ title.rawName }}</div>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Â∑¶‰æßÂäüËÉΩÈù¢Êùø -->
        <div class="article-suspended-panel">
            <div class="panel-btn" @click="setZanNum">               
                <img src="../assets/img/panelZan__on.png" alt="" v-if="zanObj.status">
                <img src="../assets/img/panelZan__off.png" alt="" v-else>
                <div class="btn-num" ref="zanNumBOX">{{zanObj.number}}</div>
            </div>
            <div class="panel-btn">
                <img src="../assets/img/panelLiu.png" alt="">
                <div class="btn-num">{{articleDetail.commentCount}}</div>
            </div>
            <div class="panel-btn">
                <img src="../assets/img/panelStar.png" alt="">
            </div>
            <div class="panel-btn">
                <img src="../assets/img/panelFa.png" alt="">
            </div>
            <div class="panel-btn">
                <img src="../assets/img/paneljing.png" alt="">
            </div>
            <div class="panel-btn">
                <img src="../assets/img/panelQuan.png" alt="">
            </div>
        </div>
      </div>
  </div>
</template>

<script>
    import '../assets/css/article.css'
    import Header from '../components/Header'
    import articleApi from '../api/article'
    import timeDispose from '../utils/timeDispose'
    import eventBus from "../assets/js/EventBus"
    import { Editor, Viewer } from '@bytemd/vue'
    import zhHans from 'bytemd/lib/locales/zh_Hans.json'
    import frontmatter from '@bytemd/plugin-frontmatter'

    const plugins = [
        // Â∞ÜÊâÄÊúâÁöÑÊâ©Â±ïÂäüËÉΩÊîæÂÖ•Êèí‰ª∂Êï∞ÁªÑ‰∏≠ÔºåÁÑ∂ÂêéÂ∞±ÂèØ‰ª•ÁîüÊïà‰∫Ü
        frontmatter()
    ]

    export default {
        data() {
            return {
                loading: true,//ÊñáÁ´†Âä†ËΩΩÁöÑÈ™®Êû∂

                articleDetail: {},
                stickyStatus: {
                    stickyBoxStatus: false
                },
                headerNavSign: true,

                zanObj: {    //ÁÇπËµûÁöÑÁä∂ÊÄÅ
                    number: null,
                    status: false
                },
                articleTime: null,

                titles: [],  //ÁõÆÂΩïÂàóË°®
                titlesLen: null,
                currentTitle: 0,

                firstTag: '', //ÊñáÁ´†Ê†áÁ≠æ

                value: '', // Ëé∑ÂèñÁöÑmarkdowÊñáÊ°£ÂÜÖÂÆπ
                zhHans,//‰∏≠ÊñáÈÖçÁΩÆ
                plugins//Êèí‰ª∂
            }
        },
        components: {
            Header,
            Editor, 
            Viewer
        },
        methods: {
            // Ëé∑ÂèñÊñáÁ´†ÁõÆÂΩïÁªìÊûÑ
            getTitles(article) {                  // ÂΩ¢ÂèÇ‰∏∫ÊñáÁ´†ÁöÑDOMËäÇÁÇπ
                let titles = [];                  // Â≠òÊîæÊñáÁ´†ÁõÆÂΩïÁªìÊûÑ
                let levels = ["h1", "h2", "h3"];  // Ê†áÈ¢òÊ†áÁ≠æ

                let articleElement = article;
                if (!articleElement) return titles;

                let elements = Array.from(articleElement.querySelectorAll("*"));// Ëé∑ÂèñÊñáÁ´†ÁöÑ‰∏≠ÊâÄÁî®Ê†áÁ≠æ
                let tagNames = new Set(elements.map((el) => el.tagName.toLowerCase()));// Ê†áÁ≠æÂéªÈáç
               
                for (let i = levels.length - 1; i >= 0; i--) {    // Â∞Ü‰∏çÂ≠òÂú®ÁöÑÊ†áÈ¢òÊ†áÁ≠æÁßªÈô§
                    if (!tagNames.has(levels[i])) levels.splice(i, 1);
                }

                let titleId = 0;
                for (let i = 0; i < elements.length; i++) {
                    const element = elements[i];
                    let tagName = element.tagName.toLowerCase();
                    let level = levels.indexOf(tagName);  // Ê†áÈ¢òÊ†áÁ≠æÂú® levels ‰∏≠ÁöÑÁ¥¢ÂºïÂÄºÂ∞±‰ª£Ë°®Ê†áÁ≠æÁöÑÁ≠âÁ∫ß
                    if (level == -1) continue;// ‰∏çÊòØÊ†áÈ¢òÊ†áÁ≠æ‰∏çÂÅöÂ§ÑÁêÜÔºåÂÉè <p> <img> Á≠âÁ≠â

                    
                    let id = tagName + "-" + element.innerText + "-" + i;
                    let node = {
                        id,
                        level,
                        parent: null,
                        children: [],
                        rawName: element.innerText,
                        scrollTop: element.offsetTop,  // ÊñáÁ´†È°µÈù¢ÊªöÂä®Êó∂ÔºåÊ†πÊçÆ scrollTop È´òÂ∫¶Âà§Êñ≠ÂΩìÂâç‰∏∫Âì™‰∏™Ê†áÈ¢ò
                        currentTitleId: titleId++
                    };

                    if (titles.length > 0) {
                        let lastNode = titles.at(-1); // Âèñ titles Êï∞ÁªÑÊúÄÂêé‰∏Ä‰∏™ÂÖÉÁ¥†

                        // ÈÅáÂà∞Â≠êÊ†áÈ¢òÔºàËÆæÁΩÆ‰∏∫Â≠êËäÇÁÇπÔºâ
                        if (lastNode.level < node.level) {
                            node.parent = lastNode;
                            lastNode.children.push(node);
                        }
                        // ÈÅáÂà∞‰∏ä‰∏ÄÁ∫ßÊ†áÈ¢òÔºàÊâæÂà∞‰ªñÁöÑÁà∂ËäÇÁÇπÔºâ
                        else if (lastNode.level > node.level) {
                            let parent = lastNode.parent;
                            while (parent) {
                                if (parent.level < node.level) {
                                    parent.children.push(node);
                                    node.parent = parent;
                                    break;
                                }
                                parent = parent.parent;
                            }
                        }
                        // ÈÅáÂà∞Âπ≥Á∫ßÔºàËÆæÁΩÆ‰∏∫ÂÖÑÂºüËäÇÁÇπÔºâ
                        else if (lastNode.parent) {
                            node.parent = lastNode.parent;
                            lastNode.parent.children.push(node);
                        }
                    }


                    node.isVisible = node.parent == null;
                    titles.push(node);
                }
                this.titlesLen = titles.length;
                return titles;
            },
            // ËÆæÁΩÆÁÇπËµûÊ†∑Âºè
            setZanNum(){
                if(!this.zanObj.status){
                    this.zanObj.number++;
                    this.zanObj.status = true;
                    this.$refs.zanNumBOX.style.background = '#1e80ff'
                }else{
                    this.zanObj.number--;
                    this.zanObj.status = false;
                    this.$refs.zanNumBOX.style.background = '#c2c8d1'
                }
            },
            // ËÆæÁΩÆÁõÆÂΩïÁöÑ‰ΩçÁΩÆ
            setStickyBoxTop(){
                // ÈÄöËøá‰∫ã‰ª∂ÊÄªÁ∫øÁõëÂê¨Ê∂àÊÅØ
                eventBus.$on('pushMsg', (children1Msg) => {
                    this.headerNavSign = children1Msg
                })

                let rect = this.$refs.authorBox.getBoundingClientRect();
                // Âà§Êñ≠Â§¥ÈÉ®ÂØºËà™Ê†èÊòØÂê¶Âá∫Áé∞
                if(this.headerNavSign){
                    this.$refs.stickyBox.style.marginTop = '60px';
                }else{
                    this.$refs.stickyBox.style.marginTop = '0px'
                }

                // Âà§Êñ≠ÁõÆÂΩïÊòØÂê¶Ë¢´Âõ∫ÂÆö
                if(rect.top < -165){
                    this.stickyStatus.stickyBoxStatus = true;
                    
                }else{
                    this.stickyStatus.stickyBoxStatus = false;
                }
            },

            // ËÆæÁΩÆÊñáÁ´†ÁöÑÊªöÂä®‰∫ã‰ª∂ÔºåÁõÆÂΩïÂìçÂ∫î
            setStickyBox(){
                if(!this.timer){
                    this.timer = true;
                    let that = this;
                    let num = 0;
                    setTimeout(function(){
                        for (let item of that.titles) 
                            if (item.scrollTop <= window.scrollY) num++;
                        that.currentTitle = num >= that.titlesLen ? that.titlesLen-1 : num
                        that.$refs.stickyContentBox.scrollTo({ top: num * 44 - 20, behavior: "smooth" });
                        that.timer = false;
                    },500)
                }
            },

            // ÊªöÂä®Âà∞ÊåáÂÆöÁöÑ‰ΩçÁΩÆ
            scrollToView(scrollTop) {
                window.scrollTo({ top: scrollTop, behavior: "smooth" });
            },

            // ËÆæÁΩÆÊñáÁ´†ÁöÑÈ£éÊ†º
            articleStyle(arr){
                for(let i=0; i<arr.length; i++){
                    if(/theme/g.test(arr[i])){
                        let fg = arr[i].split(':')[1].trim();
                        import(`juejin-markdown-themes/dist/${fg}.min.css`)
                        break;
                    }
                    if(i>10){
                        import(`juejin-markdown-themes/dist/juejin.min.css`)
                        break;
                    }
                }
            }

        },
        mounted(){
            // Â∞ÜÈ°µÈù¢ÁΩÆÈ°∂
            window.scrollTo(0, 0);
        },
        created() {
            window.addEventListener("scroll", this.setStickyBoxTop)
            window.addEventListener("scroll", this.setStickyBox)

            // ÂèëËØ∑Ê±ÇÊãøÊï∞ÊçÆ
            this.articleDetail.articleId = this.$route.params.articleId
            // ÊñáÁ´†‰ø°ÊÅØ
            articleApi.getArticleDetailById(this.articleDetail.articleId).then(resp => {
                this.articleDetail = resp.data.data.articleDetail;
                this.zanObj.number = this.articleDetail.diggCount;
                this.articleTime = timeDispose.setArticleTiem(this.articleDetail.ctime* 1000);
                // È°µÈù¢title
                document.title = this.articleDetail.title;
            })
            // ÊñáÁ´†Ê†áÁ≠æ‰ø°ÊÅØ
            articleApi.getArticleTagsById(this.articleDetail.articleId).then(resp => {
                this.articleDetail.tags = resp.data.data.tags
                let arr = this.articleDetail.tags;
                this.firstTag = arr[0];
                this.articleDetail.tags.shift();
                if(this.articleDetail.tags.length == 0){
                    this.articleDetail.tags = null;
                }
            })
            // ÊñáÁ´†ÂÜÖÂÆπ
            articleApi.getArticleContentById(this.articleDetail.articleId).then(resp => {
                
                let result = resp.data.data.articleContent;

                let styleArr = result.split('\\n');
                this.articleStyle(styleArr);//ËÆæÁΩÆÊñáÁ´†ÁöÑÈ£éÊ†º
                
                result = result.replace(/\\n/g, '\n').replace(/\\u002F/g,'/').replace(/\\u003E/g,'>');

                // Èò≤ÊäñÂ§ÑÁêÜÔºåÈò≤Ê≠¢Êï∞ÊçÆÂä†ËΩΩËøáÂø´ÔºåÈ™®Êû∂‰∏ÄÈó™ËÄåËøáÂΩ±ÂìçÊïàÊûú
                const promise = new Promise((resolve, reject)=>{
                    let self = this;
                    setTimeout(() => {
                        self.loading = false;
                        resolve();
                    }, 300);
                })

                promise.then(resp=>{
                    this.value = result;
                }).then(resp=>{
                    // ÂæóÂà∞ÊñáÁ´†ÁõÆÂΩïÂàóË°®
                    let self = this;
                    setTimeout(() => {
                        // Á≠âÂæÖÊñáÁ´†‰∏≠ÁöÑÂõæÁâáÂä†ËΩΩÂÆåÊØïÔºåÂÜçËé∑ÂèñDOMËäÇÁÇπÁîüÊàêÊñáÁ´†ÁõÆÂΩïÔºà
                        // ÂèØËÉΩ‰ºöÂõ†‰∏∫ÁΩëÁªúÂéüÂõ†ÔºåÂõæÁâáÊó†Ê≥ïÂú®ËßÑÂÆöÁöÑÊó∂Èó¥ÂÜÖÂä†ËΩΩÂÆåÊØïËÄåÁîüÊàêÈîôËØØÁöÑÊñáÁ´†ÁõÆÂΩïÔºâ
                        let article = this.$refs.articleBox.children[0];
                        self.titles = self.getTitles(article);  
                    },500);
                })
            })
        },
    }
</script>

<style scoped>

</style>