<template>
    <div class="page__main" ref="listWrap" >
        <Header :msg="true"/>
        <!-- ÊñáÁ´†ÂàóË°® -->
        <div class="page__main__contents">
            <!-- ÊñáÁ´†ÂàóË°®‰∏ª‰Ωì -->
            <div class="contents__list" ref="scrollBar">
                <div class="list__header" >
                    <div class="nav__list">
                        <ul>
                            <li><a href="" style="color: #1e80ff;">Êé®Ëçê</a></li>
                            <li><a href="">ÊúÄÊñ∞</a></li>
                            <li><a href="">ÁÉ≠Ê¶ú</a></li>
                        </ul>
                    </div>
                </div>

                <!-- Êï∞ÊçÆÂä†ËΩΩÊó∂ÂëàÁé∞ÁöÑÈ™®Êû∂ -->
                <el-skeleton :rows="4" animated style="width:700px" class="listSkeleton" v-if="loading" />
                
                <div class="list__content">
                    <ul class="article__list" ref="list">
                        <li v-for="article in showList" :key="article.articleId" class="list__item">
                            <router-link target="_blank" :to="`/detail/${article.articleId}`"  class="title">
                                <div class="entry" @click="article.color = !article.color">
                                    <div class="article__inform">
                                        <div class="nav__list">
                                            <ul>
                                                <li><a href="">{{article.userName}}</a></li>
                                                <li><a href="" >{{article.mtime}}</a></li>
                                                <li class="tag__a">
                                                    <div class="tag__name" v-for="(tag, index) in article.tagNames" :key="index">
                                                        <a href="">{{tag}}</a>
                                                    </div>
                                                </li>
                                            </ul>
                                        </div>
                                    </div>
                                    <div class="article__content">
                                        <div class="content-main">
                                            <div class="title" :class="{titleColor: article.color}">                                                {{article.title}}
                                            </div>
                                            <div class="abstract">
                                                <div>{{article.briefContent}}</div>
                                            </div>
                                            <ul class="action-list">
                                                <li class="item">
                                                    <i class="eye"></i>
                                                    <span>{{article.viewCount}}</span>
                                                </li>
                                                <li class="item">
                                                    <i class="zan"></i>
                                                    <span>{{article.diggCount}}</span>
                                                </li>
                                                <li class="item">
                                                    <i class="cloud"></i>
                                                    <span>{{article.commentCount}}</span>
                                                </li>
                                            </ul>
                                        </div>
                                        <div class="content-img" v-if="article.coverImage">
                                            <img :src="article.coverImage" alt="" class="lazy">
                                        </div>
                                    </div>
                                </div>
                            </router-link>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Âè≥‰æß‰ø°ÊÅØÊ†è -->
            <div class="sidebar">
                <!-- Á≠æÂà∞‰ø°ÊÅØ -->
                <div class="signin__top">
                    <div class="first__line">
                        <div class="icon__text">
                            <img src="../assets/img/day.png" alt="">
                            {{showTimeStage}}
                        </div>
                        <button class="signedin__btn">
                            Â∑≤Á≠æÂà∞
                        </button>
                    </div>
                    <div class="second__line">           
                        ‰Ω†Â∑≤ÁªèËøûÁª≠Á≠æÂà∞<span style="color:#1e80ff; font-size: 16px;">100</span>Â§©
                    </div>
                </div>
                <!-- ÂπøÂëä -->
                <div class="sidebar__block">
                    <img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0b6a58397c77485495a051142f1d863d~tplv-k3u1fbpfcp-no-mark:480:400:0:0.awebp?" alt="">
                </div>
                <!-- ÂπøÂëä -->
                <div class="sidebar__block">
                    <img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a88a1ea956734105a5b002dfb48840cb~tplv-k3u1fbpfcp-no-mark:480:400:0:0.awebp?" alt="">
                </div>
                <!-- ÊéòÈáëÂÆòÁΩëÈìæÊé• -->
                <div class="block-body">
                    <img src="https://lf3-cdn-tos.bytescm.com/obj/static/xitu_juejin_web/img/home.59780ae.png" alt="">
                    <div class="block-body-text">
                        <div>‰∏ãËΩΩÁ®ÄÂúüÊéòÈáëAPP</div>
                        <div>‰∏Ä‰∏™Â∏ÆÂä©ÂºÄÂèëËÄÖÊàêÈïøÁöÑÁ§æÂå∫</div>
                    </div>
                </div>
                <!-- ‰ΩúËÄÖÊ¶ú -->
                <div class="user-body user-top">
                    <div class="header-block">üéñÔ∏è‰ΩúËÄÖÊ¶ú</div>
                    <div class="user-list">
                        <div class="item">
                            <div class="item__img-box">
                                <img src="https://p3-passport.byteacctimg.com/img/mosaic-legacy/3792/5112637127~300x300.image" alt="">
                            </div>
                            <div class="item__user-info">
                                Â∞èÊòéÂêåÂ≠¶
                                <img src="../assets/img/lv-2.png" alt="">
                            </div>
                        </div>
                        <div class="item">
                            <div class="item__img-box">
                                <img src="https://p9-passport.byteacctimg.com/img/mosaic-legacy/3793/3131589739~300x300.image" alt="">
                            </div>
                            <div class="item__user-info">
                                Â∑•Âå†Ëã•Ê∞¥
                                <img src="../assets/img/lv-2.png" alt="">
                            </div>
                        </div>
                        <div class="item">
                            <div class="item__img-box">
                                <img src="https://p9-passport.byteacctimg.com/img/mosaic-legacy/3796/2975850990~300x300.image" alt="">
                            </div>
                            <div class="item__user-info">
                                Âõ∫‰ΩìÁâ©Ë¥®Êê¨ËøêÂ∑•
                                <img src="../assets/img/lv-2.png" alt="">
                            </div>
                        </div>
                    </div>
                    <div class="author-list">
                        ÂÆåÊï¥Ê¶úÂçï&nbsp;&nbsp;>
                    </div>
                </div>

                <!-- ÊÇ¨ÊµÆ‰ø°ÊÅØÊ†è -->
                <transition name="el-fade-in-linear" >
                <div class="suspended" v-show="show" ref="suspendBox">
                    <div class="signin__top ">
                        <div class="first__line">
                            <div class="icon__text">
                                <img src="../assets/img/day.png" alt="">
                                {{showTimeStage}}
                            </div>
                            <button class="signedin__btn">
                                Â∑≤Á≠æÂà∞
                            </button>
                        </div>
                        <div class="second__line">           
                            ‰Ω†Â∑≤ÁªèËøûÁª≠Á≠æÂà∞<span style="color:#1e80ff; font-size: 16px;">100</span>Â§©
                        </div>
                    </div>
                    <div class="sidebar__block user-top ">
                        <div class="header-block">üéñÔ∏è‰ΩúËÄÖÊ¶ú</div>
                        <div class="user-list">
                            <div class="item">
                                <div class="item__img-box">
                                    <img src="https://p3-passport.byteacctimg.com/img/mosaic-legacy/3792/5112637127~300x300.image" alt="">
                                </div>
                                <div class="item__user-info">
                                    Â∞èÊòéÂêåÂ≠¶
                                    <img src="../assets/img/lv-2.png" alt="">
                                </div>
                            </div>
                            <div class="item">
                                <div class="item__img-box">
                                    <img src="https://p9-passport.byteacctimg.com/img/mosaic-legacy/3793/3131589739~300x300.image" alt="">
                                </div>
                                <div class="item__user-info">
                                    Â∑•Âå†Ëã•Ê∞¥
                                    <img src="../assets/img/lv-2.png" alt="">
                                </div>
                            </div>
                            <div class="item">
                                <div class="item__img-box">
                                    <img src="https://p9-passport.byteacctimg.com/img/mosaic-legacy/3796/2975850990~300x300.image" alt="">
                                </div>
                                <div class="item__user-info">
                                    Âõ∫‰ΩìÁâ©Ë¥®Êê¨ËøêÂ∑•
                                    <img src="../assets/img/lv-2.png" alt="">
                                </div>
                            </div>
                        </div>
                        <div class="author-list">
                            ÂÆåÊï¥Ê¶úÂçï&nbsp;&nbsp;>
                        </div>
                    </div>
                </div>
                </transition>

            </div>
        </div>
    </div>
</template>

<script>
    import "../assets/css/header.css"
    import "../assets/css/main.css"
    import Header from '../components/Header'
    import article from "../api/article"
    import eventBus from "../assets/js/EventBus"
    import timeDispose from "../utils/timeDispose"

    export default {
        data() {
            return {
                loading: true,
                articleInfoList: [],
                current: 1,  // ÂΩìÂâçÈ°µ
                limit: 20,   // ÊØèÈ°µËÆ∞ÂΩïÊï∞

                itemHeight: 136,//ÊØè‰∏ÄÂàóÁöÑÈ´òÂ∫¶
                showNum: 10,//ÊòæÁ§∫Âá†Êù°Êï∞ÊçÆ
                start: 0,//ÊªöÂä®ËøáÁ®ãÊòæÁ§∫ÁöÑÂºÄÂßãÁ¥¢Âºï
                end: 10,//ÊªöÂä®ËøáÁ®ãÊòæÁ§∫ÁöÑÁªìÊùüÁ¥¢Âºï
                
                color: true,
                show: false,
                headerNavSign: true
            }
        },
        components: {
            Header
        },
        updated(){
            //ËÆ°ÁÆóÂÖ®ÈÉ®Êï∞ÊçÆÈúÄË¶ÅÁöÑÈ´òÂ∫¶ÔºåÊíëÂºÄÊªöÂä®Êù°È´òÂ∫¶
            this.$refs.scrollBar.style.height = this.itemHeight * this.articleInfoList.length + 'px';
        },
        computed: {
            //ÊòæÁ§∫ÁöÑÊï∞ÁªÑÔºåÁî®ËÆ°ÁÆóÂ±ûÊÄßËÆ°ÁÆó
            showList(){  return this.articleInfoList.slice(this.start, this.end);  },
            // ÊòæÁ§∫‰∏äÂçàÂ•Ω ‰∏ãÂçàÂ•Ω Êôö‰∏äÂ•Ω
            showTimeStage(){ return timeDispose.newTime() }

        },
        methods: {
            // ËÆ°ÁÆóÊñáÁ´†ÂàóË°®ÂëàÁé∞Âú®È°µÈù¢‰∏äÂºÄÂ§¥ÂíåÁªìÂ∞æÁöÑ‰ΩçÁΩÆ
            scrollListener(scrollTop){
                //ËÆ°ÁÆóÊÄªÁöÑÊï∞ÊçÆÈúÄË¶ÅÁöÑÈ´òÂ∫¶ÔºåÊûÑÈÄ†ÊªöÂä®Êù°È´òÂ∫¶
                this.$refs.scrollBar.style.height = this.itemHeight * this.articleInfoList.length + 'px';
                //ÂºÄÂßãÁöÑÊï∞ÁªÑÁ¥¢Âºï
                let first = Math.floor(scrollTop / this.itemHeight) - 1;
                this.start = first<0 ? 0 : first
                // if(first<0){
                //     this.start = 0;
                // }else{
                //     this.start = first
                // }
                //ÁªìÊùüÁ¥¢Âºï
                this.end = this.start + this.showNum;
                //ÂÆö‰ΩçÂàóË°®ÁöÑÈ°∂ÈÉ®ÁöÑÂÅèÁßªÈáè
                this.$refs.list.style.marginTop = this.start * this.itemHeight + 'px';
            },

            // Ëé∑ÂèñÊï∞ÊçÆ
            getArticleInfoList(current, limit){
                if (current) this.current = current
                if (limit) this.limit = limit
                article.getArticleInfo(this.current, this.limit).then(resp => {
                    let arr = resp.data.data.article_info;
                    arr.forEach((e,i)=>{
                        // arr[i].mtime = this.getLocalTime(e.mtime);
                        arr[i].mtime = timeDispose.timeInterval(e.mtime);
                        arr[i].viewCount = this.setAction(e.viewCount,1);
                        arr[i].diggCount = this.setAction(e.diggCount,2);
                        arr[i].commentCount = this.setAction(e.commentCount,3);
                        arr[i].color = true;
                    })
                    // Èò≤ÊäñÂ§ÑÁêÜÔºåÈò≤Ê≠¢Êï∞ÊçÆÂä†ËΩΩËøáÂø´ÔºåÈ™®Êû∂‰∏ÄÈó™ËÄåËøáÂΩ±ÂìçÊïàÊûú
                    const promise = new Promise((resolve, reject)=>{
                        let self = this;
                        setTimeout(() => {
                            self.loading = false;
                            resolve();
                        }, 500);
                    })
                    promise.then(resp=>{
                        this.articleInfoList.push(...arr)
                    })
                })
            },

            // ÊªöÂä®Âà∞Â∫ïÈÉ®ÂêéÂä†ËΩΩÊï∞ÊçÆ
            lasyLoading() {
                let scrollTop = document.documentElement.scrollTop || document.body.scrollTop
                let clientHeight = document.documentElement.clientHeight
                let scrollHeight = document.documentElement.scrollHeight
                if (scrollTop + clientHeight >= scrollHeight) {
                    this.current++;
                    this.getArticleInfoList()
                }
                this.scrollListener(scrollTop);
                this.show = scrollTop > 1000 ? true : false;

                // ÈÄöËøá‰∫ã‰ª∂ÊÄªÁ∫øÁõëÂê¨Ê∂àÊÅØ
                eventBus.$on('pushMsg', (children1Msg) => {
                    this.headerNavSign = children1Msg
                })
                if(this.headerNavSign){
                    this.$refs.suspendBox.style.marginTop = '0px';
                }else{
                    this.$refs.suspendBox.style.marginTop = '-60px'
                }

            },

            // Â∞ÜÊµèËßà„ÄÅÁÇπËµû„ÄÅËØÑËÆ∫Êï∞Áº©ÂÜô
            setAction(num,type){
                if(num == 0 && type == 1){
                    return 'ÊµèËßà';
                }
                if(num == 0 && type == 2){
                    return 'ÁÇπËµû';
                }
                if(num == 0 && type == 3){
                    return 'ËØÑËÆ∫';
                }
                if(num < 10000){
                    return num;
                }else if(num >= 10000){
                    return `${Math.trunc(num/10000)}.${Math.trunc((num%10000)/1000)}w`
                }
            }
        },
        watch:{
            
        },
        mounted () {
            
        },
        // ÁõëÂê¨ÊªöÂä®Âà∞Â∫ïÈÉ®‰∫ã‰ª∂
        created() {
            window.addEventListener("scroll", this.lasyLoading);
            this.getArticleInfoList();
        },
        // ÈîÄÊØÅÁõëÂê¨‰∫ã‰ª∂
        destroyed() {
            window.removeEventListener("scroll", this.lasyLoading)    
        }
    }
</script>

<style scoped>
    .listSkeleton{
        padding: 30px 20px;
        box-sizing: border-box;
        background: #fff;
    }
    .router-link-exact-active{
        color: #86909c;
    }

    .suspended{
        width: 240px;
        position: fixed;
        top: 130px;
        transition: all .3s linear;
    }
    .suspended>div{
        margin-bottom: 20px;
    }
</style>